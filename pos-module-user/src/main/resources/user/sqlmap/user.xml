<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pos.user.dao.UserDao">
    <select id="getByUserPhone" resultType="com.pos.user.domain.User">
        SELECT
        <include refid="userColumns"/>
        FROM `user` u
        WHERE u.phone = #{phone}
    </select>

    <select id="getByPhoneAndType" resultType="com.pos.user.domain.User">
        SELECT
        <include refid="userColumns"/>
        FROM `user` u
        WHERE u.phone = #{phone}
        AND u.userType = #{userType}
    </select>

    <insert id="save" parameterType="com.pos.user.domain.User" useGeneratedKeys="true" keyProperty="user.id">
        INSERT INTO `user`(
            login_name,
            password,
            phone,
            enable_status,
            user_type,
            update_time
        ) VALUE (
            #{user.loginName},
            #{user.password},
            #{user.phone},
            #{user.enable_status},
            #{user.user_type},
            NOW()
        )
    </insert>

    <update id="update" parameterType="com.pos.user.domain.User">
        UPDATE `user`
        SET password = #{user.password},
        update_time = NOW()
        WHERE `id` = #{user.id}
    </update>

    <select id="getByLoginName" resultType="com.pos.user.domain.User">
        SELECT
        <include refid="userColumns"/>
        FROM `user` u
        WHERE u.login_name = #{loginName}
        AND u.user_type = #{userType}
    </select>

    <select id="queryCustomerUserIds" resultType="java.lang.Long">
        SELECT u.id AS id
        FROM `user` u
        JOIN user_customer_personal AS ucp ON ucp.user_id = u.id
        <where>
            u.user_type = 'c'
            <if test="condition.userPhone != null">
                AND u.phone = #{condition.userPhone}
            </if>
            <if test="condition.searchKey != null">
                AND ucp.real_name LIKE CONCAT('%',#{condition.searchKey},'%')
            </if>
        </where>
    </select>

    <insert id="saveExtension" parameterType="com.pos.user.domain.UserExtension">
        INSERT INTO user_extension(
            user_id,
            register_time,
            register_info,
            last_login_time,
            last_login_info
        ) VALUE (
            #{extension.userId},
            #{extension.registerTime},
            #{extension.registerInfo},
            #{extension.lastLoginTime},
            #{extension.lastLoginInfo}
        )
    </insert>

    <select id="getExtension" resultType="com.pos.user.domain.UserExtension">
        SELECT
        <include refid="userExtensionColumns"/>
        FROM user_extension ue
        WHERE ue.user_id = #{userId}
    </select>

    <update id="updateExtension" parameterType="com.pos.user.domain.UserExtension">
        UPDATE user_extension
        SET last_login_time = #{extension.lastLoginTime}
        <if test="extension.lastLoginInfo != null">
            last_login_info = #{extension.lastLoginInfo}
        </if>
        WHERE `id` = #{extension.id}
    </update>

    <sql id="userExtensionColumns">
        ue.`id` AS `id`,
        ue.user_id AS userId,
        ue.register_time AS registerTime,
        ue.register_info AS registerInfo,
        ue.last_login_time AS lastLoginTime,
        ue.last_login_info AS lastLoginInfo
    </sql>

    <sql id="userColumns">
        u.`id` AS `id`,
        u.login_name AS loginName,
        u.password AS password,
        u.phone AS phone,
        u.enable_status AS enableStatus,
        u.user_type AS userType,
        u.update_time AS updateTime
    </sql>
</mapper>