<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pos.user.dao.EmployeeDao">

    <insert id="save" parameterType="com.pos.user.domain.Employee">
        INSERT INTO employee
        (
          user_id,
          user_detail_type,
          company_id,
          nick_name,
          head_image,
          life_photos,
          resume,
          public_phone,
          advertorial,
          service_content
        )
        VALUES
        (
          #{e.userId},
          #{e.userDetailType},
          #{e.companyId},
          #{e.nickName},
          #{e.headImage},
          #{e.lifePhotos},
          #{e.resume},
          #{e.publicPhone},
          #{e.advertorial},
          #{e.serviceContent}
        );
    </insert>

    <update id="update" parameterType="com.pos.user.domain.Employee">
        UPDATE employee
        SET
        user_detail_type = #{e.userDetailType},
        company_id = #{e.companyId},
        nick_name = #{e.nickName},
        head_image = #{e.headImage},
        life_photos = #{e.lifePhotos},
        resume = #{e.resume},
        public_phone = #{e.publicPhone},
        quit_jobs = #{e.quitJobs},
        <if test="e.serviceContent != null">
            service_content = #{e.serviceContent},
        </if>
        <if test="e.invitationCode != null">
           invitationCode = #{e.invitationCode},
        </if>
        advertorial = #{e.advertorial}
        WHERE id = #{e.id}
    </update>

    <select id="getByUserId" resultType="com.pos.user.domain.Employee">
        SELECT
        <include refid="employeeColumns"/>
        FROM employee e WHERE e.user_id = #{userId}
    </select>

    <select id="findEmployeeByUserId" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE u.id = #{userId}
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        AND uc.user_type = 'e'
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findEmployeeByUserName" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE u.user_name = #{userName}
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        AND uc.user_type = 'e'
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findEmployeeByUserPhone" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE u.user_phone = #{userPhone}
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        AND uc.user_type = 'e'
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findEmployeeForImMember" resultType="com.pos.user.dto.SessionUserDto">
        SELECT
        u.id as userId,
        u.`name` as name,
        u.user_phone as mobilePhone,
        uc.user_type as userType,
        e.user_detail_type as userDetailType,
        com.name as company
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        INNER JOIN company com ON e.company_id = com.id
        WHERE uc.user_type = 'e'
        <if test="userPhone != null">
            AND u.user_phone = #{userPhone}
        </if>
        <if test="quitJob != null">
            AND e.quit_jobs = #{quitJob}
        </if>
        <if test="name != null">
            AND u.name = #{name}
        </if>
        <if test="company != null">
            AND  com.name LIKE CONCAT('%', #{company}, '%')
        </if>
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findEmployeesByName" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE u.name LIKE CONCAT(#{name}, '%') AND uc.user_type = 'e'
        <if test="companyId != null">
            AND e.company_id = #{companyId}
        </if>
        <if test="quitJob != null">
            AND e.quit_jobs = #{quitJob}
        </if>
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        <if test="available != null">
            AND uc.available = #{available}
        </if>
        LIMIT 0, #{maxSize}
    </select>

    <select id="findEmployeesByNameAndType" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE u.name LIKE CONCAT('%', #{name}, '%')
        AND uc.user_type = 'e'
        <if test="employeeType != null">
            AND e.user_detail_type = #{employeeType}
        </if>
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findEmployeesByCompaniesId" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE e.company_id IN
        <foreach item="cid" index="index" collection="companiesId" open="(" separator="," close=")">
            #{cid}
        </foreach>
        AND uc.user_type = 'e'
        <if test="quitJob != null">
            AND e.quit_jobs = #{quitJob}
        </if>
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        <if test="available != null">
            AND uc.available = #{available}
        </if>
        LIMIT 0, #{maxSize}
    </select>

    <select id="getEmployees" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        e.user_id AS id,
        e.user_detail_type AS userDetailType,
        e.public_phone as publicPhone,
        e.head_image AS headImage,
        u.`name` AS `name`,
        u.user_phone AS userPhone,
        uc.available AS available,
        uc.update_time AS updateTime,
        uc.create_time AS createTime
        FROM employee AS e
        JOIN `user` AS u ON e.user_id = u.id
        JOIN user_class AS uc ON uc.user_id = u.id
        <where>
            uc.user_type = 'e'
            <if test="condition.companyId != null">
                AND e.company_id = #{condition.companyId}
            </if>
            <if test="condition.queryKey != null and condition.queryKey != ''">
                AND (u.`name` LIKE CONCAT('%',#{condition.queryKey},'%') OR u.user_phone LIKE CONCAT('%',#{condition.queryKey},'%'))
            </if>
            <if test="condition.userDetailType != null">
                AND e.user_detail_type = #{condition.userDetailType}
            </if>
            <if test="condition.available != null">
                AND uc.available = #{condition.available}
            </if>
            <if test="condition.quitJobs != null">
                AND e.quit_jobs = #{condition.quitJobs}
            </if>
            AND u.deleted = 0
        </where>
        <if test="orderHelper != null">
            ORDER BY ${orderHelper.fieldName} ${orderHelper.ordination}
        </if>
        limit #{limitHelper.offset}, #{limitHelper.pageSize}
    </select>

    <select id="queryCollectionEmployees" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        e.user_id AS id,
        e.user_detail_type AS userDetailType,
        e.public_phone as publicPhone,
        e.company_id AS companyId,
        e.head_image as headImage,
        u.`name` AS name
        FROM employee AS e
        JOIN `user` AS u ON e.user_id = u.id
        JOIN employee_collection AS r ON r.employee_id = u.id
        WHERE r.user_id = #{userId}
        AND r.user_type = #{userType}
        AND r.available = 1
        ORDER BY r.update_time DESC
        limit #{limitHelper.offset}, #{limitHelper.pageSize}
    </select>

    <select id="getTotalEmployeeCount" resultType="java.lang.Integer">
        SELECT
        COUNT(*)
        FROM employee AS e
        JOIN `user` AS u ON e.user_id = u.id
        JOIN user_class AS uc ON u.id = uc.user_id
        <where>
            u.deleted = 0
            <if test="condition.companyId != null">
                AND e.company_id = #{condition.companyId}
            </if>
            <if test="condition.queryKey != null and condition.queryKey != ''">
                AND (u.`name` LIKE CONCAT('%',#{condition.queryKey},'%') OR u.user_phone LIKE CONCAT('%',#{condition.queryKey},'%'))
            </if>
            <if test="condition.userDetailType != null">
                AND e.user_detail_type = #{condition.userDetailType}
            </if>
            <if test="condition.available != null">
                AND uc.available = #{condition.available}
            </if>
            <if test="condition.quitJobs != null">
                AND e.quit_jobs = #{condition.quitJobs}
            </if>
            AND uc.user_type = 'e'
        </where>
    </select>

    <select id="findInUserIds" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE u.id IN
        <foreach collection="userIds" item="id" index="index" open="(" separator="," close=")">
            #{id}
        </foreach>
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        AND uc.user_type = 'e'
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findByInvitationCode" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE e.invitationCode = #{invitationCode}
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        AND uc.user_type = 'e'
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="queryEmployees" resultType="com.pos.user.dto.employee.EmployeeDto">
        SELECT
        <include refid="employeeDtoColumns"/>
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE uc.user_type = 'e'
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        <if test="available != null">
            AND uc.available = #{available}
        </if>
        LIMIT #{limitHelper.offset}, #{limitHelper.pageSize}
    </select>

    <select id="findByUserDetailType" resultType="com.pos.user.dto.employee.EmployeeInfoDto">
        SELECT
          e.user_id AS userId,
          u.name AS userName,
          e.user_detail_type AS userDetailType
        FROM `user` u
        INNER JOIN user_class uc ON u.id = uc.user_id
        INNER JOIN employee e ON u.id = e.user_id
        WHERE uc.user_type = 'e'
        <if test="userDetailType != null">
            AND e.user_detail_type = #{userDetailType}
        </if>
        <if test="companyId != null">
            AND e.company_id = #{companyId}
        </if>
        <if test="quitJob != null">
            AND e.quit_jobs = #{quitJob}
        </if>
        <if test="deleted != null">
            AND u.deleted = #{deleted}
        </if>
        <if test="available != null">
            AND uc.available = #{available}
        </if>
    </select>

    <select id="findCompany" resultType="java.lang.String">
        SELECT
           `name`
        FROM company
        WHERE
           id = #{companyId}
    </select>

    <sql id="employeeColumns">
        e.id as id,
        e.user_id as userId,
        e.user_detail_type as userDetailType,
        e.company_id as companyId,
        e.nick_name as nickName,
        e.head_image as headImage,
        e.life_photos as lifePhotos,
        e.resume as resume,
        e.quit_jobs as quitJobs,
        e.public_phone as publicPhone,
        e.service_content AS serviceContent,
        e.advertorial as advertorial,
        e.invitationCode as invitationCode
    </sql>

    <sql id="employeeDtoColumns">
        u.id as id,
        u.user_name as userName,
        u.user_phone as userPhone,
        u.deleted as deleted,
        u.mail as mail,
        u.name as `name`,
        u.gender as gender,
        u.id_card as idCard,
        u.id_image_a as idImageA,
        u.id_image_b as idImageB,
        u.id_hold_image as idHoldImage,
        uc.id as userTypeId,
        uc.user_type as userType,
        uc.available as available,
        uc.create_user as createUserId,
        uc.create_time as createTime,
        uc.update_time as updateTime,
        uc.last_login_time as lastLoginTime,
        e.user_detail_type as userDetailType,
        e.id as entityId,
        e.company_id as companyId,
        e.nick_name as nickName,
        e.head_image as headImage,
        e.life_photos as lifePhotos,
        e.resume as resume,
        e.quit_jobs as quitJobs,
        e.public_phone as publicPhone,
        e.service_content AS serviceContent,
        e.advertorial as articles,
        e.invitationCode as invitationCode
    </sql>

</mapper>