<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pos.user.dao.CustomerDao">
    <insert id="saveCustomerBase" parameterType="com.pos.user.domain.Customer">
        INSERT INTO user_customer_base(
            user_id,
            mail,
            nick_name,
            head_image,
            gender,
            age,
            source_type,
            NOW()
        ) VALUE (
            #{customer.userId},
            #{customer.mail},
            #{customer.nickName},
            #{customer.headImage},
            #{customer.gender},
            #{customer.age},
            #{customer.sourceType},
            NOW()
        )
    </insert>

    <select id="getByUserId" resultType="com.pos.user.dto.CustomerDto">
        SELECT
        <include refid="customerDtoColumns"/>
        FROM `user` u
        JOIN user_customer_base AS ucp ON ucp.user_id = u.`id`
        LEFT JOIN user_extension AS ue ON ue.user_id = ucp.user_id
        LEFT JOIN user_customer_personal AS ucp ON ucp.user_id = u.`id`
        WHERE u.`id` = #{userId}
    </select>

    <select id="findByUserIdAndEnable" resultType="com.pos.user.dto.CustomerDto">
        SELECT
        <include refid="customerDtoColumns"/>
        FROM `user` u
        JOIN user_customer_base AS ucp ON ucp.user_id = u.`id`
        LEFT JOIN user_extension AS ue ON ue.user_id = ucp.user_id
        LEFT JOIN user_customer_personal AS ucp ON ucp.user_id = u.`id`
        WHERE u.`id` = #{userId}
        <if test="enable != null">
            AND u.enable_status = #{enable}
        </if>
    </select>

    <sql id="customerDtoColumns">
        u.`id` AS `id`,
        u.login_name AS loginName,
        u.phone AS phone,
        u.enable_status AS enableStatus,
        u.user_type AS userType,
        ue.register_time AS registerTime,
        ue.last_login_time AS lastLoginTime,
        ucb.mail AS mail,
        ucb.nick_name AS nickName,
        ucb.head_image AS headImage,
        ucb.gender AS gender,
        ucb.age AS age,
        ucb.source_type AS sourceType,
        ucp.real_name AS realName,
        ucp.id_card_no AS idCardNo,
        ucp.id_image_a AS idImageA,
        ucp.id_image_b AS idImageB,
        ucp.id_hold_image AS idHoldImage
    </sql>
</mapper>