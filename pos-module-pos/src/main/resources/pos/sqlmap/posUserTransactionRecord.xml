<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pos.pos.dao.PosUserTransactionRecordDao">

    <select id="queryTransactionRecordCount" resultType="int">
        SELECT COUNT(*)
        FROM `transaction` tr
        <include refid="conditionColumns"/>
    </select>

    <select id="queryTransactionRecord" resultType="com.pos.pos.domain.PosTransaction">
        SELECT
        <include refid="recordColumns"/>
        FROM `transaction` tr
        <include refid="conditionColumns"/>
        <if test="orderHelper != null">
            ORDER BY ${orderHelper.fieldName} ${orderHelper.ordination}
        </if>
        LIMIT #{limitHelper.offset}, #{limitHelper.pageSize}
    </select>

    <select id="querySimpleStatistics" resultType="com.pos.pos.dto.transaction.TransactionSimpleStatisticsDto">
        SELECT
          tr.user_id AS userId,
          COUNT(*) AS transactionCount,
          SUM(tr.amount) AS transactionAmount
        FROM `transaction` tr
        WHERE tr.user_id IN
        <foreach collection="userIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND (tr.status = 3 OR tr.status = 4)
        GROUP BY tr.user_id
    </select>

    <update id="updateTransactionOutCardInfo" parameterType="com.pos.pos.domain.PosTransaction">
        UPDATE `transaction`
        SET out_card_info = #{record.outCardInfo}
        WHERE id = #{record.id}
    </update>

    <sql id="conditionColumns">
        <if test="condition != null">
            <where>
                <if test="condition.id != null">
                    tr.id = #{condition.id}
                </if>
                <if test="condition.recordNum != null">
                    AND tr.record_num = #{condition.recordNum}
                </if>
                <if test="condition.userId != null">
                    AND tr.user_id = #{condition.userId}
                </if>
                <if test="condition.includeUserIds != null">
                    AND tr.user_id IN
                    <foreach collection="condition.includeUserIds" index="index" item="item" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="condition.status != null">
                    AND tr.status = #{condition.status}
                </if>
                <if test="condition.excludedStatuses != null">
                    AND tr.status NOT IN
                    <foreach collection="condition.excludedStatuses" index="index" item="item" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="condition.beginDate != null">
                    AND tr.create_time &gt;= #{condition.beginDate}
                </if>
                <if test="condition.endDate != null">
                    AND tr.create_time &lt;= #{condition.endDate}
                </if>
            </where>
        </if>
    </sql>

    <sql id="recordColumns">
        tr.id AS id,
        tr.record_num AS recordNum,
        tr.in_card_id AS inCardId,
        tr.out_card_info AS outCardInfo,
        tr.user_id AS userId,
        tr.amount AS amount,
        tr.service_charge AS serviceCharge,
        tr.arrival_amount AS arrivalAmount,
        tr.pay_charge AS payCharge,
        tr.pos_charge AS posCharge,
        tr.company_id AS companyId,
        tr.cost_type AS costType,
        tr.status AS status,
        tr.create_time AS createTime,
        tr.helibao_zhifu_num AS helibaoZhifuNum,
        tr.helibao_tixian_num AS helibaoTixianNum,
        tr.pay_time AS payTime,
        tr.complete_time AS completeDate
    </sql>
</mapper>