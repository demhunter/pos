<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pos.im.dao.InternalMessageDao">

    <insert id="save" parameterType="com.pos.im.domain.InternalMessage" useGeneratedKeys="true"
            keyProperty="msg.id">
        INSERT INTO im_internal_message (`type`, sub_type, title, content, extend_info, target_id, send_time, parameters)
        VALUES
        (#{msg.type}, #{msg.subType}, #{msg.title}, #{msg.content}, #{msg.extendInfo}, #{msg.targetId}, #{msg.sendTime}, #{msg.parameters});
    </insert>

    <insert id="saveReceivers" parameterType="java.util.List">
        INSERT INTO
        im_internal_message_receiver (msg_id, user_id, user_type)
        VALUES
        <foreach collection="list" item="receiver" index="index" separator=",">
            (#{receiver.msgId}, #{receiver.userId}, #{receiver.userType})
        </foreach>
    </insert>

    <insert id="saveReceiver" parameterType="com.pos.im.domain.InternalMessageReceiver">
        INSERT INTO im_internal_message_receiver
        (
            msg_id,
            user_id,
            user_type)
        VALUES (
            #{receiver.msgId},
            #{receiver.userId},
            #{receiver.userType}
        )
    </insert>

    <select id="get" resultType="com.pos.im.dto.message.InternalMessageDto">
        SELECT
        <include refid="internalMessageDtoColumns"/>
        FROM im_internal_message msg
        WHERE msg.id = #{id}
    </select>

    <select id="findByCondition" resultType="com.pos.im.dto.message.InternalMessageDto">
        SELECT
        <include refid="internalMessageDtoColumns"/>
        FROM im_internal_message msg
        <if test="condition.receiverId != null and condition.receiverType != null">
            INNER JOIN im_internal_message_receiver imr ON imr.msg_id = msg.id
        </if>
        <where>
            <if test="condition.receiverId != null and condition.receiverType != null">
                imr.user_id = #{condition.receiverId}
                AND imr.user_type = #{condition.receiverType}
            </if>
            <if test="condition.msgTypes != null">
                AND msg.type IN
                <foreach item="msgType" index="index" collection="condition.msgTypes" open="(" separator="," close=")">
                   #{msgType}
                </foreach>
            </if>
            <if test="condition.sendBeginTime != null">
                AND msg.send_time &gt;= #{condition.sendBeginTime}
            </if>
            <if test="condition.sendEndTime != null">
                AND msg.send_time &lt;= #{condition.sendEndTime}
            </if>
        </where>
        <if test="orderHelper != null">
            ORDER BY ${orderHelper.fieldName} ${orderHelper.ordination}
        </if>
        LIMIT #{limitHeler.offset}, #{limitHeler.pageSize}
    </select>

    <select id="getTotalByCondition" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM im_internal_message msg
        <if test="condition.receiverId != null and condition.receiverType != null">
            INNER JOIN im_internal_message_receiver imr ON imr.msg_id = msg.id
        </if>
        <where>
            <if test="condition.receiverId != null and condition.receiverType != null">
                imr.user_id = #{condition.receiverId}
                AND imr.user_type = #{condition.receiverType}
            </if>
            <if test="condition.msgTypes != null">
                AND msg.type IN
                <foreach item="msgType" index="index" collection="condition.msgTypes" open="(" separator="," close=")">
                    #{msgType}
                </foreach>
            </if>
            <if test="condition.sendBeginTime != null">
                AND msg.send_time &gt;= #{condition.sendBeginTime}
            </if>
            <if test="condition.sendEndTime != null">
                AND msg.send_time &lt;= #{condition.sendEndTime}
            </if>
        </where>
    </select>

    <sql id="internalMessageDtoColumns">
        msg.id AS id,
        msg.type AS `type`,
        msg.sub_type AS subType,
        msg.title AS title,
        msg.content AS content,
        msg.extend_info AS extendInfo,
        msg.target_id AS targetId,
        msg.send_time AS sendTime,
        msg.parameters AS parameters
    </sql>

</mapper>